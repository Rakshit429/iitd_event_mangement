<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ club_name }} Portal - KARS</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --sidebar-bg: rgba(20, 20, 40, 0.7);
            --card-bg: rgba(35, 35, 65, 0.6);
            --text-color: #f0f0f0;
            --border-color: rgba(255, 255, 255, 0.2);
            --input-bg: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-color);
            transition: margin-left 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            padding: 1rem 0;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .sidebar-header img {
            max-width: 60px;
            margin-bottom: 0.5rem;
        }

        .sidebar-header h5 {
            font-weight: 600;
            color: #fff;
        }

        .sidebar .nav-pills .nav-link {
            color: var(--text-color);
            padding: 0.8rem 1.5rem;
            margin: 0.2rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 500;
            border-radius: 0;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        .sidebar .nav-pills .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: var(--secondary-color);
        }

        .sidebar .nav-pills .nav-link.active {
            background: rgba(37, 117, 252, 0.2);
            border-left-color: var(--secondary-color);
            color: #fff;
            font-weight: 600;
        }

        .sidebar .nav-link i {
            font-size: 1.2rem;
        }

        /* --- Main Content --- */
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(8px);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* --- Event Card --- */
        .event-card {
            background: var(--input-bg);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .event-card-img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        /* --- Forms --- */
        .form-control,
        .form-select {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        .form-control:focus,
        .form-select:focus {
            background-color: var(--input-bg);
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(37, 117, 252, 0.25);
            color: var(--text-color);
        }

        select option {
            background-color: #2c2f48;
        }

        /* --- Modals --- */
        .modal-content {
            background: #2c2f48;
            border: 1px solid var(--border-color);
        }

        .modal-header,
        .modal-footer {
            border-bottom-color: var(--border-color);
            border-top-color: var(--border-color);
        }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                margin-left: -260px;
                z-index: 1030;
                height: 100%;
            }

            .sidebar.active {
                margin-left: 0;
            }

            .mobile-menu-toggle {
                display: block !important;
            }

            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1029;
            }

            .sidebar.active~.overlay {
                display: block;
            }
        }
    </style>
</head>

<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="{{ url_for('uploaded_file', filename=club_profile.logo_path) if club_profile and club_profile.logo_path else url_for('static', filename='logo.png') }}"
                alt="Club Logo" class="rounded-circle">
            <h5 class="mt-2 text-white">{{ club_name }}</h5>
        </div>

        <!-- Nav tabs -->
        <ul class="nav nav-pills flex-column w-100" id="main-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab"
                    aria-controls="dashboard" aria-selected="true">
                    <i class="bi bi-grid-1x2-fill"></i><span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="events-tab" data-bs-toggle="tab" href="#events" role="tab"
                    aria-controls="events" aria-selected="false">
                    <i class="bi bi-calendar-event-fill"></i><span>All Events</span>
                </a>
            </li>
            <!-- PERMISSION CHECK: Only show Settings tab to Club Head -->
            {% if session.get('auth_role') == 'club_head' %}
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="settings-tab" data-bs-toggle="tab" href="#settings" role="tab"
                    aria-controls="settings" aria-selected="false">
                    <i class="bi bi-gear-fill"></i><span>Settings & Team</span>
                </a>
            </li>
            {% endif %}
        </ul>

        <div class="mt-auto p-3 w-100">
            <a class="nav-link" href="{{ url_for('logout') }}"><i
                    class="bi bi-box-arrow-left"></i><span>Logout</span></a>
        </div>
    </div>

    <div class="overlay" onclick="toggleSidebar()"></div>

    <main class="main-content">
        <!-- Flash Messages & Mobile Toggle -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <button class="btn btn-light d-lg-none mobile-menu-toggle" type="button" onclick="toggleSidebar()">
                <i class="bi bi-list fs-4"></i>
            </button>
            <div class="position-absolute top-0 end-0 p-3" style="z-index: 1100">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show"
                    role="alert" style="background-color: rgba(0,0,0,0.4); border-color: var(--border-color);">
                    <strong>{{ category|title }}:</strong> {{ message }}
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"
                        aria-label="Close"></button>
                </div>
                {% endfor %}
                {% endif %}
                {% endwith %}
            </div>
        </div>

        <!-- Tab content -->
        <div class="tab-content" id="myTabContent">
            <!-- DASHBOARD TAB -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="glass-card mb-4">
                    <h1 class="text-white">{{ club_name }} Club Dashboard</h1>
                    <p class="lead text-white-50">Welcome back, {{ club_manager_name }}!</p>
                    <div class="row g-3 mt-3">
                        <div class="col-md-4">
                            <div class="p-3 rounded text-center" style="background: rgba(37, 117, 252, 0.3);">
                                <h3 class="display-6 fw-bold">{{ stats.managed_events_count }}</h3>
                                <p class="mb-0">Managed Events</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 rounded text-center" style="background: rgba(106, 17, 203, 0.3);">
                                <h3 class="display-6 fw-bold">{{ stats.upcoming_events_count }}</h3>
                                <p class="mb-0">Upcoming Events</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 rounded text-center" style="background: rgba(37, 117, 252, 0.3);">
                                <h3 class="display-6 fw-bold">{{ stats.total_registrations_count }}</h3>
                                <p class="mb-0">Total Registrations</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2 class="text-white">My Managed Events</h2>
                        <!-- PERMISSION CHECK: Show "Add Event" to any team member -->
                        {% if session.get('auth_role') in ['club_head', 'club_coordinator', 'club_executive'] %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
                            <i class="bi bi-plus-circle-fill me-2"></i>Add New Event
                        </button>
                        {% endif %}
                    </div>
                    <div class="row g-4">
                        {% if managed_events %}
                        {% for event in managed_events %}
                        <div class="col-xl-4 col-md-6">
                            <div class="event-card">
                                <img src="{{ url_for('uploaded_file', filename=event.photo) if event.photo else url_for('static', filename='default_event.jpg') }}"
                                    class="event-card-img" alt="{{ event.name }}">
                                <div class="p-3">
                                    <h5 class="card-title text-white">{{ event.name }}</h5>
                                    <p class="card-text text-white-50 small">
                                        <i class="bi bi-calendar-fill"></i> {{ event.date }}  
                                        <i class="bi bi-clock-fill"></i> {{ event.starttime }}  
                                        <i class="bi bi-geo-alt-fill"></i> {{ event.venue }}
                                    </p>
                                    <p class="card-text small">{{ event.description|truncate(100) }}</p>
                                    <div class="d-grid gap-2 d-md-flex justify-content-end">
                                        <a href="{{ url_for('edit_club_event', event_name=event.name) }}"
                                            class="btn btn-outline-info btn-sm"><i class="bi bi-pencil-fill"></i>
                                            Edit</a>
                                        <button class="btn btn-info btn-sm"
                                            onclick="viewClubRegistrations('{{ event.name }}')"><i
                                                class="bi bi-people-fill"></i> View Registrations</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center py-5 text-white-50">
                            <i class="bi bi-calendar-x-fill display-4"></i>
                            <h4 class="mt-3">No Events Managed By You</h4>
                            <p>Click "Add New Event" to create one.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ALL EVENTS TAB -->
            <div class="tab-pane fade" id="events" role="tabpanel" aria-labelledby="events-tab">
                <div class="glass-card">
                    <h2 class="text-white mb-3">All {{ club_name }} Club Events</h2>
                    <div class="row g-4">
                        {% if all_club_events %}
                        {% for event in all_club_events %}
                        <div class="col-xl-4 col-md-6">
                            <div class="event-card">
                                <img src="{{ url_for('uploaded_file', filename=event.photo) if event.photo else url_for('static', filename='default_event.jpg') }}"
                                    class="event-card-img" alt="{{ event.name }}">
                                <div class="p-3">
                                    <h5 class="card-title text-white">{{ event.name }}</h5>
                                    <p class="card-text text-white-50 small">
                                        <i class="bi bi-calendar-fill"></i> {{ event.date }}  
                                        <i class="bi bi-person-check-fill"></i> Managed by: {{ event.event_manager }}
                                    </p>
                                    <p class="card-text small">{{ event.description|truncate(100) }}</p>
                                    <!-- PERMISSION CHECK: Show buttons if user is Head/Coordinator OR the event manager -->
                                    {% if session.get('auth_role') in ['club_head', 'club_coordinator'] or
                                    event.event_manager == club_manager_name %}
                                    <div class="d-grid gap-2 d-md-flex justify-content-end">
                                        <a href="{{ url_for('edit_club_event', event_name=event.name) }}"
                                            class="btn btn-outline-info btn-sm"><i class="bi bi-pencil-fill"></i>
                                            Edit</a>
                                        <button class="btn btn-info btn-sm"
                                            onclick="viewClubRegistrations('{{ event.name }}')"><i
                                                class="bi bi-people-fill"></i> View Registrations</button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center py-5 text-white-50">
                            <i class="bi bi-calendar-x-fill display-4"></i>
                            <h4 class="mt-3">No events found for this club.</h4>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- SETTINGS TAB (CLUB HEAD ONLY) -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                {% if session.get('auth_role') == 'club_head' %}
                <!-- Section 1: Club Profile & Data Management -->
                <div class="glass-card mb-4">
                    <h2 class="text-white">Club Profile & Data</h2>
                    <div class="row g-4 mt-2">
                        <div class="col-lg-8">
                            <form action="{{ url_for('update_club_profile') }}" method="POST"
                                enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="description" class="form-label">Club Description / Charter</label>
                                    <textarea name="description" id="description" rows="6"
                                        class="form-control">{{ club_profile.description if club_profile else '' }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="logo" class="form-label">Upload New Logo (replaces current)</label>
                                    <input type="file" name="logo" id="logo" class="form-control" accept="image/*">
                                </div>
                                <button type="submit" class="btn btn-primary">Save Profile Changes</button>
                            </form>
                        </div>
                        <div class="col-lg-4">
                            <h5 class="text-white">Data Exports</h5>
                            <p class="text-white-50 small">Download CSV files of your club's data.</p>
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('export_club_data', export_type='members') }}"
                                    class="btn btn-outline-light"><i class="bi bi-people-fill me-2"></i>Export Member
                                    List</a>
                                <a href="{{ url_for('export_club_data', export_type='registrations') }}"
                                    class="btn btn-outline-light"><i class="bi bi-clipboard-data-fill me-2"></i>Export
                                    All Registrations</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Team Management -->
                <div class="glass-card">
                    <h2 class="text-white">Team Management</h2>
                    <p class="text-white-50">Appoint, manage, and remove roles for your club's core team.</p>
                    <div class="glass-card p-3 my-3">
                        <form action="{{ url_for('manage_team_action') }}" method="POST"
                            class="row g-2 align-items-end">
                            <input type="hidden" name="action" value="add">
                            <div class="col-md-6">
                                <label for="user_email_select" class="form-label">Select User to Appoint</label>
                                <select name="email" id="user_email_select" class="form-select" required>
                                    <option value="" disabled selected>-- Choose a verified user --</option>
                                    {% for user in all_users %}
                                    <option value="{{ user.email }}">{{ user.name }} ({{ user.email }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="role_select" class="form-label">Assign Role</label>
                                <select name="role" id="role_select" class="form-select" required>
                                    <option value="club_coordinator">Coordinator</option>
                                    <option value="club_executive">Executive</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-grid">
                                <button type="submit" class="btn btn-success"><i class="bi bi-person-plus-fill"></i>
                                    Appoint</button>
                            </div>
                        </form>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-dark table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in team_members %}
                                <tr>
                                    <td>{{ member.name }}</td>
                                    <td>{{ member.email }}</td>
                                    <td><span class="badge bg-info text-dark">{{ member.role.replace('_', ' ').title()
                                            }}</span></td>
                                    <td class="text-center">
                                        {% if member.role != 'club_head' %}
                                        <div class="btn-group btn-group-sm">
                                            <form action="{{ url_for('manage_team_action') }}" method="POST"
                                                class="d-inline">
                                                <input type="hidden" name="action" value="update_role">
                                                <input type="hidden" name="auth_id" value="{{ member.id }}">
                                                {% if member.role == 'club_executive' %}
                                                <input type="hidden" name="role" value="club_coordinator">
                                                <button type="submit" class="btn btn-outline-success"
                                                    title="Promote to Coordinator"><i
                                                        class="bi bi-arrow-up-circle"></i></button>
                                                {% elif member.role == 'club_coordinator' %}
                                                <input type="hidden" name="role" value="club_executive">
                                                <button type="submit" class="btn btn-outline-warning"
                                                    title="Demote to Executive"><i
                                                        class="bi bi-arrow-down-circle"></i></button>
                                                {% endif %}
                                            </form>
                                            <form action="{{ url_for('manage_team_action') }}" method="POST"
                                                onsubmit="return confirm('Are you sure? This will remove their role from the team.');"
                                                class="d-inline">
                                                <input type="hidden" name="action" value="remove">
                                                <input type="hidden" name="auth_id" value="{{ member.id }}">
                                                <button type="submit" class="btn btn-outline-danger"
                                                    title="Remove from Team"><i class="bi bi-trash"></i></button>
                                            </form>
                                        </div>
                                        {% else %}
                                        <span class="text-white-50 small">Admin Role</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-white-50">No team members found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="glass-card text-center text-white-50 py-5">
                    <i class="bi bi-lock-fill display-4"></i>
                    <h4 class="mt-3">Access Denied</h4>
                    <p>Only Club Heads can access these settings.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </main>

    <!-- Add Event Modal -->
    <div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addEventModalLabel">Add New Club Event</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addEventForm" action="{{ url_for('create_club_event') }}" method="POST"
                        enctype="multipart/form-data">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label for="eventName" class="form-label">Event Name</label>
                                <input type="text" class="form-control" id="eventName" name="eventName" required>
                            </div>
                            <div class="col-md-4">
                                <label for="eventCategory" class="form-label">Category (Optional)</label>
                                <input type="text" class="form-control" id="eventCategory" name="event_category"
                                    placeholder="e.g., Workshop">
                            </div>
                            <div class="col-12">
                                <label for="eventPhoto" class="form-label">Event Photo/Banner</label>
                                <input class="form-control" type="file" id="eventPhoto" name="photo" accept="image/*"
                                    required>
                            </div>
                            <div class="col-12">
                                <label for="eventDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="eventDescription" name="description" rows="3"
                                    required></textarea>
                            </div>
                            <div class="col-md-4">
                                <label for="eventDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="eventDate" name="date" required>
                            </div>
                            <div class="col-md-4">
                                <label for="eventStartTime" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="eventStartTime" name="starttime" required>
                            </div>
                            <div class="col-md-4">
                                <label for="eventEndTime" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="eventEndTime" name="endtime" required>
                            </div>
                            <div class="col-12">
                                <label for="eventVenue" class="form-label">Venue</label>
                                <input type="text" class="form-control" id="eventVenue" name="venue" required>
                            </div>
                            <div class="col-md-6">
                                <label for="eventTags" class="form-label">Tags (comma-separated)</label>
                                <input type="text" class="form-control" id="eventTags" name="tags"
                                    placeholder="Coding, Music, Fun" required>
                            </div>
                            <div class="col-md-6">
                                <label for="eventLink" class="form-label">Registration Link (Optional)</label>
                                <input type="url" class="form-control" id="eventLink" name="link">
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                        id="is_private_checkbox" name="is_private" value="true">
                                    <label class="form-check-label" for="is_private_checkbox">Member-Only Event (Visible
                                        only to past attendees)</label>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4" style="border-color: var(--border-color)">
                        <h5 class="mb-3">Custom Registration Questions</h5>
                        <div id="custom-fields-container"></div>
                        <input type="hidden" name="custom_field_count" id="custom_field_count" value="0">
                        <button type="button" class="btn btn-outline-info w-100" onclick="addQuestionField()">
                            <i class="bi bi-plus-lg"></i> Add Question
                        </button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="addEventForm" class="btn btn-primary">Create Event</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Registrations Modal -->
    <div class="modal fade" id="registrationsModal" tabindex="-1" aria-labelledby="registrationsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registrationsTitle">Event Registrations</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="regDashboardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="list-tab" data-bs-toggle="tab"
                                data-bs-target="#registrant-list" type="button" role="tab">Registrant List</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics"
                                type="button" role="tab">Analytics</button>
                        </li>
                    </ul>
                    <div class="tab-content pt-3">
                        <div class="tab-pane fade show active" id="registrant-list" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-striped table-hover" id="registrantListTable">
                                    <!-- JS will populate this -->
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="analytics" role="tabpanel">
                            <div class="row g-4">
                                <div class="col-lg-6">
                                    <div class="glass-card h-100"><canvas id="yearChart"></canvas></div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="glass-card h-100"><canvas id="deptChart"></canvas></div>
                                </div>
                            </div>
                            <div id="customChartsContainer" class="row g-4 mt-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- Sidebar & Tab Management ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        document.addEventListener('DOMContentLoaded', function () {
            const hash = window.location.hash;
            if (hash) {
                const tab = document.querySelector(`.nav-link[href="${hash}"]`);
                if (tab) {
                    new bootstrap.Tab(tab).show();
                }
            }
            // Handle image load errors
            document.querySelectorAll('.event-card-img').forEach(img => {
                img.onerror = () => { img.src = "{{ url_for('static', filename='default_event.jpg') }}"; };
            });
        });

        // --- Registrations Modal & Analytics ---
        const registrationsModal = new bootstrap.Modal(document.getElementById('registrationsModal'));
        let activeCharts = [];

        function viewClubRegistrations(eventName) {
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];

            registrationsModal.show();
            document.getElementById('registrationsTitle').textContent = `${eventName} - Registrations`;
            const table = document.getElementById('registrantListTable');
            table.innerHTML = '<thead><tr><th><div class="spinner-border spinner-border-sm" role="status"></div> Loading...</th></tr></thead>';

            // Reset to first tab
            new bootstrap.Tab(document.getElementById('list-tab')).show();

            fetch(`/api/club-event/${encodeURIComponent(eventName)}/registrations`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    renderRegistrations(data);
                    renderAnalytics(data.analytics);
                })
                .catch(err => {
                    console.error('Error fetching registrations:', err);
                    table.innerHTML = `<thead><tr><th class="text-danger">Error</th></tr></thead><tbody><tr><td>${err.message}</td></tr></tbody>`;
                });
        }

        function renderRegistrations(data) {
            const table = document.getElementById('registrantListTable');
            let headerHTML = '<tr><th>Name</th><th>Email</th><th>Entry No</th><th>Year</th>';
            data.custom_fields.forEach(f => { headerHTML += `<th>${f.text}</th>`; });
            headerHTML += '</tr>';

            let bodyHTML = '';
            if (data.registrants.length > 0) {
                data.registrants.forEach(r => {
                    let row = `<tr><td>${r.name}</td><td>${r.email}</td><td>${r.entryno}</td><td>${r.year || 'N/A'}</td>`;
                    data.custom_fields.forEach(f => { row += `<td>${r.custom_answers[f.id] || 'N/A'}</td>`; });
                    row += '</tr>';
                    bodyHTML += row;
                });
            } else {
                bodyHTML = `<tr><td colspan="${4 + data.custom_fields.length}" class="text-center py-4">No one has registered yet.</td></tr>`;
            }
            table.innerHTML = `<thead>${headerHTML}</thead><tbody>${bodyHTML}</tbody>`;
        }

        function renderAnalytics(analytics) {
            const chartOptions = { plugins: { legend: { labels: { color: '#fff' } } } };
            const barChartOptions = { ...chartOptions, indexAxis: 'y', scales: { y: { ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } } };
            const colors = ['#5D3FD3', '#7c5ce0', '#9a7ee8', '#b99ff0', '#d7bff8', '#4cc9f0', '#4895ef'];

            if (Object.keys(analytics.year_distribution).length > 0) {
                activeCharts.push(new Chart('yearChart', { type: 'doughnut', data: { labels: Object.keys(analytics.year_distribution), datasets: [{ data: Object.values(analytics.year_distribution), backgroundColor: colors }] }, options: chartOptions }));
            }
            if (Object.keys(analytics.department_distribution).length > 0) {
                activeCharts.push(new Chart('deptChart', { type: 'bar', data: { labels: Object.keys(analytics.department_distribution), datasets: [{ label: 'Departments', data: Object.values(analytics.department_distribution), backgroundColor: '#7c5ce0' }] }, options: barChartOptions }));
            }

            const customChartsContainer = document.getElementById('customChartsContainer');
            customChartsContainer.innerHTML = '';
            for (const fieldId in analytics.custom_question_analytics) {
                const d = analytics.custom_question_analytics[fieldId];
                if (Object.keys(d.responses).length > 0) {
                    const col = document.createElement('div');
                    col.className = 'col-md-6';
                    col.innerHTML = `<div class="glass-card h-100"><h5>${d.question}</h5><canvas id="custom-chart-${fieldId}"></canvas></div>`;
                    customChartsContainer.appendChild(col);
                    activeCharts.push(new Chart(`custom-chart-${fieldId}`, { type: 'pie', data: { labels: Object.keys(d.responses), datasets: [{ data: Object.values(d.responses), backgroundColor: colors }] }, options: chartOptions }));
                }
            }
        }


        // --- Custom Form Builder for Add Event Modal ---
        let questionCounter = 0;
        function addQuestionField() {
            const container = document.getElementById('custom-fields-container');
            const i = questionCounter;
            const newFieldHTML = `
                <div class="glass-card p-3 mb-3" id="field-group-${i}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">Question ${i + 1}</span>
                        <button type="button" class="btn-close btn-close-white" onclick="removeQuestionField(${i})"></button>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Question Text</label>
                        <input type="text" class="form-control" name="question_text_${i}" required>
                    </div>
                    <div class="row g-2">
                        <div class="col">
                            <label class="form-label small">Question Type</label>
                            <select class="form-select" name="question_type_${i}" onchange="toggleOptionsInput(this,${i})">
                                <option value="text">Short Answer</option>
                                <option value="textarea">Paragraph</option>
                                <option value="radio">Multiple Choice</option>
                                <option value="checkbox">Checkboxes</option>
                            </select>
                        </div>
                        <div class="col-auto d-flex align-items-end">
                             <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_required_${i}" id="is_required_${i}">
                                <label class="form-check-label small" for="is_required_${i}">Required</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 d-none" id="options-input-${i}">
                        <label class="form-label small">Choices (comma-separated)</label>
                        <input type="text" class="form-control" name="options_${i}" placeholder="Option A, Option B, Option C">
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', newFieldHTML);
            questionCounter++;
            document.getElementById('custom_field_count').value = questionCounter;
        }

        function removeQuestionField(index) {
            const fieldGroup = document.getElementById(`field-group-${index}`);
            if (fieldGroup) {
                // We don't remove, just hide and clear inputs to avoid re-indexing issues on form submission
                fieldGroup.innerHTML = `<p class="text-center text-danger small p-2">Question removed.</p>`;
                fieldGroup.querySelectorAll('input, select').forEach(el => el.removeAttribute('name'));
            }
        }

        function toggleOptionsInput(select, index) {
            const optionsInput = document.getElementById(`options-input-${index}`);
            optionsInput.classList.toggle('d-none', !(select.value === 'radio' || select.value === 'checkbox'));
        }

        // Reset form on modal close
        document.getElementById('addEventModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('addEventForm').reset();
            document.getElementById('custom-fields-container').innerHTML = '';
            questionCounter = 0;
            document.getElementById('custom_field_count').value = 0;
        });

    </script>
</body>

</html>